<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>薬膳アプリ（チェック → 食材提案）</title>
  <style>
    :root{
      /* Green theme */
      --bg1:#0b3b2a;
      --bg2:#0f5a3a;
      --bg3:#13824f;

      --panel:#ffffff;
      --panel2:#f6fff9;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.10);

      --primary:#16a34a;
      --primary2:#22c55e;
      --primary-weak: rgba(34,197,94,.12);

      --shadow: 0 16px 40px rgba(2, 12, 8, 0.22);
      --shadow-sm: 0 10px 22px rgba(2, 12, 8, 0.18);

      --radius:18px;
      --radius2:22px;

      --font: system-ui, -apple-system, "Noto Sans JP", "Meiryo", sans-serif;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(34,197,94,.35), transparent 60%),
        radial-gradient(800px 520px at 100% 0%, rgba(16,185,129,.28), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1) 55%, #06261a 100%);
      min-height:100vh;
    }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }

    .appShell{
      border-radius: 26px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topHeader{
      padding: 18px 18px 14px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      color:#eafff1;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:40px; height:40px; border-radius: 14px;
      background: linear-gradient(135deg, var(--primary2), #a3e635);
      box-shadow: var(--shadow-sm);
    }
    .brand h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .brand p{ margin:4px 0 0; font-size:12px; opacity:.85; }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      font-size:12px;
      color:#eafff1;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.35);
    }
    .dot.on{ background: #a7f3d0; }

    .content{
      padding: 14px;
      display:grid;
      gap: 14px;
    }

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.6);
      border-radius: var(--radius2);
      box-shadow: 0 10px 26px rgba(2, 12, 8, 0.18);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 14px 10px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-end;
      background: linear-gradient(180deg, rgba(34,197,94,.10), rgba(255,255,255,0));
      border-bottom: 1px solid rgba(15,23,42,.06);
    }
    .cardHead h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .cardHead p{
      margin:6px 0 0;
      font-size:12px;
      color: var(--muted);
    }

    .cardBody{ padding: 12px 14px 14px; }

    /* Buttons */
    .btn{
      appearance:none;
      border: 1px solid rgba(15,23,42,.10);
      background: #fff;
      color: #0f172a;
      padding: 11px 14px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 800;
      box-shadow: 0 2px 0 rgba(15, 23, 42, 0.03);
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff;
      border-color: rgba(34,197,94,.35);
      box-shadow: 0 14px 24px rgba(34,197,94,.24);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .bottomBar{
      position: sticky;
      bottom: 0;
      padding: 12px 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
      background: rgba(255,255,255,.92);
      border-top: 1px solid rgba(15,23,42,.06);
      backdrop-filter: blur(10px);
    }
    @media (max-width: 700px){
      .bottomBar{ justify-content:space-between; }
      .btn{ width: 100%; }
    }

    /* Question groups */
    .q-groups{ display:grid; gap:10px; }
    .group{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      overflow:hidden;
      background: #fff;
    }
    .group > button{
      width:100%;
      text-align:left;
      padding: 12px 12px;
      border:0;
      background: linear-gradient(180deg, rgba(34,197,94,.09), rgba(255,255,255,1));
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight: 900;
    }
    .group > button span{ font-size:13px; }
    .group > button small{ color: var(--muted); font-weight:800; }
    .items{
      padding: 10px 12px 12px;
      display:grid;
      gap: 10px;
      background: #f6fff9;
      border-top: 1px solid rgba(15,23,42,.06);
    }
    .q-item{
      display:flex; gap:10px;
      align-items:flex-start;
      padding: 10px 10px;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      background: #fff;
    }
    .q-item input{ margin-top: 3px; transform: scale(1.1); accent-color: var(--primary); }
    .q-item .meta{ font-size:12px; color: var(--muted); margin-top:4px; }

    /* Result page */
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .between{ justify-content:space-between; }
    .field{
      display:flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 14px;
      background: rgba(246,255,249,.95);
    }
    .field label{ font-size:12px; color: var(--muted); font-weight:800; }
    select{ border:0; background: transparent; font-weight:900; color:#0f172a; outline:none; cursor:pointer; }

    .list{ display:grid; gap:10px; }
    .line{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding: 12px;
      background:#fff;
    }

    /* ===== ピル（共通） ===== */
    .pill{
      display:inline-flex; align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      font-size: 12px;
      font-weight: 900;
      line-height: 1.2;
      background: #f1f5f9;
      color: #0f172a;
    }
    .pill.score{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.30);
      color:#166534;
    }
    .pill.warn{
      background: rgba(245,158,11,.12);
      border-color: rgba(245,158,11,.26);
      color: #92400e;
    }

    .ingCard{
      margin-top:10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.10);
      background: linear-gradient(180deg, rgba(34,197,94,.08), #fff 55%);
    }
    .ingCard h4{ margin:0; font-size:14px; }
    .muted{ color: var(--muted); }
    .divider{ height:1px; background: rgba(15,23,42,.08); margin: 10px 0; }

    .hidden{ display:none !important; }

    /* ===== 五性・五味 マーク表示 ===== */
    .marks{ margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; }

    /* 五性：寒涼平温熱 */
    .t-寒{ background: rgba(59,130,246,.14); border-color: rgba(59,130,246,.30); color:#1d4ed8; }
    .t-涼{ background: rgba(14,165,233,.14); border-color: rgba(14,165,233,.30); color:#0369a1; }
    .t-平{ background: rgba(107,114,128,.12); border-color: rgba(107,114,128,.26); color:#374151; }
    .t-温{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.30); color:#92400e; }
    .t-熱{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.30); color:#b91c1c; }

    /* 五味：甘渋苦辛鹹 */
    .s-甘{ background: rgba(234,179,8,.16); border-color: rgba(234,179,8,.32); color:#854d0e; }   /* 黄 */
    .s-渋{ background: rgba(20,184,166,.14); border-color: rgba(20,184,166,.30); color:#0f766e; }  /* 青緑 */
    .s-苦{ background: rgba(168,85,247,.14); border-color: rgba(168,85,247,.30); color:#6b21a8; }  /* 紫 */
    .s-辛{ background: rgba(244,63,94,.14); border-color: rgba(244,63,94,.30); color:#be123c; }    /* 赤 */
    .s-鹹{ background: rgba(99,102,241,.14); border-color: rgba(99,102,241,.30); color:#3730a3; }   /* 藍 */
  </style>
</head>

<body>
  <div class="wrap">
    <div class="appShell">
      <div class="topHeader">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>薬膳アプリ</h1>
            <p>チェック → 食材提案</p>
          </div>
        </div>

        <div class="badge" id="stepBadge">
          <span class="dot on" id="dot1"></span><span>診断</span>
          <span style="opacity:.5;">→</span>
          <span class="dot" id="dot2"></span><span>結果</span>
        </div>
      </div>

      <div class="content">
        <!-- =========================
             第1画面：体調チェック
             ========================= -->
        <section class="card" id="screenCheck">
          <div class="cardHead">
            <div>
              <h2>体調チェック項目</h2>
              <p id="loadStatus">読み込み中…</p>
            </div>
            <div class="row">
              <span class="pill" id="checkedCountPill">チェック 0</span>
            </div>
          </div>

          <div class="cardBody">
            <div id="questionGroups" class="q-groups"></div>
          </div>

          <div class="bottomBar">
            <button id="btnReset" class="btn">リセット</button>
            <button id="btnRecommend" class="btn primary">提案する</button>
          </div>
        </section>

        <!-- =========================
             第2画面：結果
             ========================= -->
        <section class="card hidden" id="screenResult">
          <div class="cardHead">
            <div>
              <h2>結果</h2>
              <p class="muted">カテゴリ別の提案食材と、目的ベクトルTopを表示します。</p>
            </div>
            <div class="row">
              <div class="field">
                <label>カテゴリ TopN</label>
                <select id="topN">
                  <option value="3" selected>3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                </select>
              </div>
              <button id="btnBack" class="btn">診断へ戻る</button>
            </div>
          </div>

          <div class="cardBody">
            <h3 style="margin:0 0 10px; font-size:14px;">目的ベクトル Top</h3>
            <div id="purposeTop" class="list"></div>

            <div class="divider"></div>

            <h3 style="margin:0 0 10px; font-size:14px;">カテゴリー別 提案食材</h3>
            <div id="categoryTop" class="list"></div>

            <div style="margin-top:12px;" class="muted" id="resultFooterNote"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CSVパス
 *  ========================= */
const DATA = {
  questions: "./questions.csv",
  ingredients: "./ingredients.csv",
  map: "./purpose_ingredient_map.csv",
};

let QUESTIONS = [];
let INGREDIENTS = [];
let MAP = [];
let INGREDIENTS_BY_ID = new Map();

// purpose -> [{ingredient_id, strength, priority, rationale}]
let MAP_BY_PURPOSE = new Map();
// ingredient -> [{purpose_id, strength}]
let VEC_BY_INGREDIENT = new Map();

const $ = (id) => document.getElementById(id);

/** CSV（引用符対応） */
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i], nx = text[i+1];
    if(ch === '"'){
      if(inQ && nx === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
      continue;
    }
    if(!inQ && ch === ','){ row.push(cur); cur=""; continue; }
    if(!inQ && (ch === '\n' || ch === '\r')){
      if(ch === '\r' && nx === '\n') i++;
      row.push(cur); cur="";
      rows.push(row); row=[];
      continue;
    }
    cur += ch;
  }
  row.push(cur); rows.push(row);
  return rows.filter(r => r.some(c => String(c).trim() !== ""));
}
function rowsToObjects(rows){
  const header = rows[0].map(h => h.trim());
  return rows.slice(1).map(r => {
    const o = {};
    header.forEach((h,idx)=> o[h] = (r[idx] ?? "").trim());
    return o;
  });
}
async function loadCSV(url){
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error(`CSV load failed: ${url} (${res.status})`);
  return await res.text();
}
function splitList(s){
  if(!s) return [];
  return String(s).split(/[,、]/).map(x=>x.trim()).filter(Boolean);
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => (
    s === "&" ? "&amp;" :
    s === "<" ? "&lt;" :
    s === ">" ? "&gt;" :
    s === '"' ? "&quot;" : "&#39;"
  ));
}
function pill(text, cls=""){
  return `<span class="pill ${cls}">${escapeHtml(text)}</span>`;
}

/** 五性：寒涼平温熱 */
function tempClass(t){
  const v = (t||"").trim();
  if(["寒","涼","平","温","熱"].includes(v)) return `t-${v}`;
  return "warn";
}
/** 五味：甘渋苦辛鹹 */
function tasteClass(s){
  const v = (s||"").trim();
  if(["甘","渋","苦","辛","鹹"].includes(v)) return `s-${v}`;
  return "";
}
/** 五性・五味のマーク（食材ごとに色付き表示） */
function renderPropertyMarks(ing){
  const temp = ing.temperature
    ? pill(ing.temperature, tempClass(ing.temperature))
    : pill("五性?", "warn");

  const tastesArr = splitList(ing.taste);
  const tastes = tastesArr.length
    ? tastesArr.map(t => pill(t, tasteClass(t))).join(" ")
    : pill("五味?", "warn");

  return `<div class="marks">${temp} ${tastes}</div>`;
}

/** 目的ID */
function makePurposeId(organ, element, state){ return `P_${organ}_${element}_${state}`; }

/** 目的ベクトル（u） */
function buildPurposeVector(){
  const vector = new Map();
  const checkedQs = QUESTIONS.filter(q => q._checked);
  for(const q of checkedQs){
    const w = Number(q.weight || 1);
    const pid = makePurposeId(q.organ, q.element, q.state);
    vector.set(pid, (vector.get(pid)||0) + w);
  }
  return vector;
}
function normFromMap(vecMap){
  let s = 0;
  for(const v of vecMap.values()) s += v*v;
  return Math.sqrt(s);
}
function purposeTopList(purposeVector, topK=10){
  return [...purposeVector.entries()].sort((a,b)=>b[1]-a[1]).slice(0, topK);
}

/** map構造構築（purpose->rows, ingredient->vector） */
function buildMapIndexes(){
  MAP_BY_PURPOSE = new Map();
  VEC_BY_INGREDIENT = new Map();

  for(const m of MAP){
    const pid = m.purpose_id;
    const iid = m.ingredient_id;
    const strength = Number(m.strength || 1);
    const priority = Number(m.priority || 999);
    const rationale = m.rationale || "";

    if(!MAP_BY_PURPOSE.has(pid)) MAP_BY_PURPOSE.set(pid, []);
    MAP_BY_PURPOSE.get(pid).push({ ingredient_id: iid, strength, priority, rationale });

    if(!VEC_BY_INGREDIENT.has(iid)) VEC_BY_INGREDIENT.set(iid, []);
    VEC_BY_INGREDIENT.get(iid).push({ purpose_id: pid, strength });
  }

  // priority順（説明の上位表示に効く）
  for(const [pid, arr] of MAP_BY_PURPOSE.entries()){
    arr.sort((a,b)=>a.priority-b.priority);
  }
}

/** 食材スコア（内積＋コサイン類似のハイブリッド） */
function scoreIngredientsHybrid(u){
  const normU = normFromMap(u);
  const agg = new Map(); // iid -> {dot, cos, final, contrib[]}
  if(normU === 0) return { agg, normU };

  // dot: uの次元から集計
  for(const [pid, uVal] of u.entries()){
    const rows = MAP_BY_PURPOSE.get(pid) || [];
    for(const r of rows){
      const iid = r.ingredient_id;
      if(!agg.has(iid)) agg.set(iid, { dot:0, cos:0, final:0, contrib:[] });

      const obj = agg.get(iid);
      const add = uVal * r.strength;
      obj.dot += add;
      obj.contrib.push({
        purpose_id: pid,
        purpose_score: uVal,
        strength: r.strength,
        add,
        priority: r.priority,
        rationale: r.rationale
      });
    }
  }

  // cosine と final
  for(const [iid, obj] of agg.entries()){
    const vec = VEC_BY_INGREDIENT.get(iid) || [];
    let sumF2 = 0;
    for(const it of vec){
      const f = Number(it.strength || 0);
      sumF2 += f*f;
    }
    const normF = Math.sqrt(sumF2);
    const cos = (obj.dot > 0 && normF > 0) ? (obj.dot / (normU * normF)) : 0;

    obj.cos = cos;
    obj.final = obj.dot * cos;
  }

  return { agg, normU };
}

/** カテゴリごとに TopN（メイン/サポートは分けない） */
function buildCategoryRanking(ingredientAgg, topN=3){
  // category -> {items:[], bestScore:number}
  const byCat = new Map();

  for(const [iid, s] of ingredientAgg.entries()){
    const ing = INGREDIENTS_BY_ID.get(iid);
    if(!ing) continue;

    const cat = ing.category || "その他";
    if(!byCat.has(cat)) byCat.set(cat, { category: cat, items: [], bestScore: 0 });

    byCat.get(cat).items.push({
      ingredient: ing,
      final: s.final,
      contrib: s.contrib
    });
    byCat.get(cat).bestScore = Math.max(byCat.get(cat).bestScore, s.final);
  }

  const cats = [...byCat.values()];
  for(const c of cats){
    c.items.sort((a,b)=>b.final-a.final);
    c.items = c.items.slice(0, topN).map((x, idx)=>({ rank: idx+1, ...x }));
  }
  cats.sort((a,b)=>b.bestScore-a.bestScore);
  return cats;
}

/** UI：質問描画（noteでグルーピング） */
function renderQuestions(){
  const groups = new Map();
  for(const q of QUESTIONS){
    const k = q.note || "その他";
    if(!groups.has(k)) groups.set(k, []);
    groups.get(k).push(q);
  }

  const wrap = $("questionGroups");
  wrap.innerHTML = "";

  for(const [note, items] of groups.entries()){
    const g = document.createElement("div");
    g.className = "group";

    const btn = document.createElement("button");
    btn.innerHTML = `<span>${escapeHtml(note)}</span><small>${items.length}件</small>`;
    btn.onclick = () => {
      const el = g.querySelector(".items");
      el.style.display = (el.style.display === "none") ? "grid" : "none";
    };

    const list = document.createElement("div");
    list.className = "items";

    for(const q of items){
      const id = `q_${q.question_id}`;
      const div = document.createElement("div");
      div.className = "q-item";
      div.innerHTML = `
        <input type="checkbox" id="${escapeHtml(id)}">
        <div>
          <label for="${escapeHtml(id)}"><strong>${escapeHtml(q.question_text)}</strong></label>
          <div class="meta">${escapeHtml(q.organ)} × ${escapeHtml(q.element)} × ${escapeHtml(q.state)} ｜ weight=${escapeHtml(q.weight || 1)}</div>
        </div>
      `;
      list.appendChild(div);
    }

    g.appendChild(btn);
    g.appendChild(list);
    wrap.appendChild(g);
  }
}
function syncChecked(){
  let n = 0;
  for(const q of QUESTIONS){
    const el = document.getElementById(`q_${q.question_id}`);
    q._checked = !!el?.checked;
    if(q._checked) n++;
  }
  $("checkedCountPill").innerHTML = `チェック ${n}`;
  return n;
}
function resetUI(){
  for(const q of QUESTIONS){
    const el = document.getElementById(`q_${q.question_id}`);
    if(el) el.checked = false;
    q._checked = false;
  }
  $("checkedCountPill").innerHTML = `チェック 0`;
}

/** 結果描画（第2画面） */
let LAST_RESULT = null; // {u, agg}

function renderResultScreen(){
  if(!LAST_RESULT) return;

  const topN = Number($("topN").value);
  const { u, agg } = LAST_RESULT;

  // Purpose Top
  const pTop = purposeTopList(u, 10);
  const pWrap = $("purposeTop");
  pWrap.innerHTML = "";
  if(pTop.length === 0){
    pWrap.innerHTML = `<div class="line">${pill("目的スコアがありません", "warn")}</div>`;
  } else {
    for(const [pid, sc] of pTop){
      const parts = pid.split("_");
      const div = document.createElement("div");
      div.className = "line";
      div.innerHTML = `
        <div class="row between">
          <div class="row">
            ${pill(`${parts[1]}×${parts[2]}×${parts[3]}`)}
            <span class="muted">${escapeHtml(pid)}</span>
          </div>
          ${pill(`score ${sc}`, "score")}
        </div>
      `;
      pWrap.appendChild(div);
    }
  }

  // Category ranking (TopN)
  const cats = buildCategoryRanking(agg, topN);
  const cWrap = $("categoryTop");
  cWrap.innerHTML = "";

  if(cats.length === 0){
    cWrap.innerHTML = `<div class="line">${pill("該当食材がありません", "warn")}</div>`;
  } else {
    for(const c of cats){
      const box = document.createElement("div");
      box.className = "line";

      const itemsHtml = (c.items || []).map(it => {
        // ingredients側の詳細（note等）
        const details = [
          it.ingredient.note ? `note: ${it.ingredient.note}` : "",
          it.ingredient.target_organs ? `対象: ${it.ingredient.target_organs}` : "",
          it.ingredient.element_action ? `作用: ${it.ingredient.element_action}` : ""
        ].filter(Boolean).join(" / ");

        // map側の理由（rationale）上位2つ
        const reason = (it.contrib || [])
          .slice()
          .sort((a,b)=> (a.priority-b.priority) || (b.add-a.add))
          .map(x => x.rationale)
          .filter(Boolean)
          .slice(0,2)
          .join(" / ");

        return `
          <div class="ingCard">
            <div class="row between">
              <div style="min-width:0;">
                <div class="row">
                  ${pill(`#${it.rank}`)}
                  <h4>${escapeHtml(it.ingredient.name)}</h4>
                </div>

                ${details
                  ? `<div class="muted" style="margin-top:6px;">${escapeHtml(details)}</div>`
                  : `<div class="muted" style="margin-top:6px;">詳細:（未設定）</div>`}

                ${reason ? `<div class="muted" style="margin-top:6px;">理由: ${escapeHtml(reason)}</div>` : ``}

                <!-- ✅ 五性・五味（色付き表示） -->
                ${renderPropertyMarks(it.ingredient)}
              </div>

              <div>
                ${pill(it.final.toFixed(2), "score")}
              </div>
            </div>
          </div>
        `;
      }).join("");

      box.innerHTML = `
        <div class="row between">
          <div class="row">
            ${pill(escapeHtml(c.category))}
            <span class="muted">best=${c.bestScore.toFixed(2)}</span>
          </div>
          ${pill(`TopN=${topN}`)}
        </div>
        ${itemsHtml || `<div class="muted" style="margin-top:10px;">該当なし</div>`}
      `;

      cWrap.appendChild(box);
    }
  }

  $("resultFooterNote").textContent =
    "※スコアは「内積×コサイン類似度」のハイブリッド最終スコアです（内積/コサインの個別値は非表示）。";
}

/** 画面遷移 */
function goTo(step){
  const isResult = (step === 2);
  $("screenCheck").classList.toggle("hidden", isResult);
  $("screenResult").classList.toggle("hidden", !isResult);

  $("dot1").classList.toggle("on", !isResult);
  $("dot2").classList.toggle("on", isResult);
}

/** 正規化（列名揺れ吸収） */
function normalizeIngredientRow(ing){
  ing.ingredient_id = ing.ingredient_id || ing["Ingredient id"] || ing["id"] || "";
  ing.name = ing.name || ing["Name"] || "";
  ing.category = ing.category || ing["Category"] || "その他";

  // 五性（temperature） / 五味（taste）
  ing.temperature = ing.temperature || ing["Temperature"] || "";
  ing.taste = ing.taste || ing["Taste"] || "";

  ing.target_organs = ing.target_organs || ing.target_organ || ing["Target organ"] || "";
  ing.element_action = ing.element_action || ing["Element action"] || "";
  ing.role = ing.role || ing["Role"] || ""; // 使わないが列は保持
  ing.note = ing.note || ing["Note"] || "";
  return ing;
}
function normalizeQuestionRow(q){
  q.question_id = q.question_id || q["Question id"] || q["id"] || "";
  q.question_text = q.question_text || q["Question text"] || "";
  q.organ = q.organ || q["Organ"] || "";
  q.element = q.element || q["Element"] || "";
  q.state = q.state || q["State"] || "";
  q.weight = q.weight || "1";
  q.note = q.note || q["Note"] || "";
  return q;
}
function normalizeMapRow(m){
  m.purpose_id = m.purpose_id || "";
  m.ingredient_id = m.ingredient_id || "";
  m.strength = m.strength || "1";
  m.priority = m.priority || "999";
  m.rationale = m.rationale || "";
  return m;
}

/** Load */
async function loadAll(){
  $("loadStatus").textContent = "CSVを読み込み中…";
  const [qTxt, iTxt, mTxt] = await Promise.all([
    loadCSV(DATA.questions),
    loadCSV(DATA.ingredients),
    loadCSV(DATA.map),
  ]);

  QUESTIONS = rowsToObjects(parseCSV(qTxt)).map(normalizeQuestionRow);
  INGREDIENTS = rowsToObjects(parseCSV(iTxt)).map(normalizeIngredientRow);
  MAP = rowsToObjects(parseCSV(mTxt)).map(normalizeMapRow);

  INGREDIENTS_BY_ID = new Map(INGREDIENTS.map(x => [x.ingredient_id, x]));
  buildMapIndexes();

  const missing = MAP.filter(m => !INGREDIENTS_BY_ID.has(m.ingredient_id)).length;
  $("loadStatus").innerHTML =
    `OK: questions=${QUESTIONS.length}, ingredients=${INGREDIENTS.length}, map=${MAP.length}` +
    (missing ? ` / <span style="color:#b45309;font-weight:900;">mapに存在するがingredientsに無い ingredient_id が ${missing} 件</span>` : ``);

  renderQuestions();
}

/** Events */
$("btnReset").addEventListener("click", ()=>{
  resetUI();
});

$("btnRecommend").addEventListener("click", ()=>{
  const checkedCount = syncChecked();
  if(checkedCount === 0){
    alert("チェックが0件です。1つ以上選択してください。");
    return;
  }

  const u = buildPurposeVector();
  const { agg } = scoreIngredientsHybrid(u);

  LAST_RESULT = { u, agg };

  renderResultScreen();
  goTo(2);
});

$("btnBack").addEventListener("click", ()=>{
  goTo(1);
});

$("topN").addEventListener("change", ()=>{
  renderResultScreen();
});

loadAll().catch(e=>{
  console.error(e);
  $("loadStatus").textContent = `読み込み失敗: ${e.message}`;
});

/* 第1画面のチェック数ピルをリアルタイム更新（任意） */
document.addEventListener("change", (ev)=>{
  if(ev.target && ev.target.type === "checkbox" && String(ev.target.id||"").startsWith("q_")){
    syncChecked();
  }
});
</script>
</body>
</html>
